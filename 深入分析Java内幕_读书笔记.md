# 一、Web请求

## 1.HTTP解析

* 请求头
* 响应头
* ctrl+F5强制请求服务器，不走缓存，请求头会新增`Pragma:no-cache`和`Cache-Control:no-cache`

## 2.DNS域名解析

1. 浏览器检查缓存中有没有这个域名对应的解析过的IP，如果有解析过程结束。

2. 如果没有，查找操作系统的hosts文件，是否有对应映射。可能导致域名劫持。

3. 如果hosts没有映射，操作系统会把这个域名发送给LDNS，本地区的域名服务器，就是本机配置网络的DNS。

4. 如果LDNS还没有命中，就直接向Root Server域名服务器请求解析。

5. 跟域名服务器返回给本地域名服务器一个所查询域的主域名服务器地址，gTLD。

6. 本地域名服务器再向上一步返回的gTLD服务器发送请求。

7. 接收请求的gTLD服务器查找并返回此域名对应的Name Server域名服务器的地址，这个Name Server通常是自己注册的域名服务器。

8. Name Server域名服务器会查询存储的域名和IP的映射关系表，正常情况下得到域名对应的IP和一个TTL值返回给DNS Server域名服务器。

9. 返回该域名对应的IP和TTL值，Local DNS Server会缓存这个域名和IP的对应关系，缓存时间由TTL值控制。

10. 把解析的结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程完毕。

    ![img](https://img-blog.csdn.net/20171211190812796?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbTBfMzc4MTI1MTM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)  

## 3.CDN工作机制

### 3.1 概念

CDN是内容分布网络，是一种先进的流量分配网络。在Internet上增加一层新的网络架构，将网站内容发布到最接近用户的网络“边缘”，是用户可以就近取得所需的内容，提高响应速度。例如：缓存网络中的静态资源，CSS、JS、图片和静态页面等数据。

### 3.2 目的

* 可扩展。
  * 性能可扩展：应对新增的大量数据、用户和事务的扩展能力。
  * 成本可扩展性：用低廉的运营成本提供动态的服务能力和高质量的内容分发。
* 安全性。强调提供物理设备、网络、软件、数据和服务过程的安全性，减少因为DDOS攻击或其他恶意行为造成商业网站的业务中断。
* 可靠性、响应和执行。服务可用性指能够处理可能的故障和用户体验下降的问题，通过负载均衡及时提供网络的容错机制。

### 3.3 负载均衡

​	负载均衡就是对工作任务进行平衡、分摊到多个操作单元上执行，如图片服务器、应用服务器，共同完成工作任务。可以提高服务器响应速度及利用率，避免软件或者硬件模块单点失效，解决网络拥塞问题，实现地理位置无关性，为用户提供较一致的访问质量。

* 链路负载均衡。链路负载均衡由DNS解析完成，用户最终访问哪个Web Server有DNS Server控制，由Global DNS Server动态解析域名服务。
  * 优点：用户直接访问目标服务器，不需要经过其他代理服务器，访问速度更快。
  * 缺点：由于DNS在用户本地和Local DNS Server都有缓存，一旦某台Web Server挂点，很难及时更新域名解析缓存，导致用户无法访问该域名。
* 集群负载均衡。
  * 硬件负载均衡。F5，价格贵但是支持较好。
  * 软件负载均衡。成本低，会有代理服务器，增加网络成本。
    * LVS，四层负载，网络层利用IP地址进行转发。
    * HAProxy，七层负载，根据访问的HTTP请求头来进行负载均衡，如根据不同URL将请求转发到特定集群或者根据用户Cookie信息来指定访问机器。
* 操作系统负载均衡。利用操作系统级别的软中断和硬中断达到负载均衡，如可以设置多队列网卡来实现。

### 3.4 CDN动态加速

​	CDN动态加速是目前比较流行的一种优化技术，其原理就是在CDN的DNS解析中通过动态的链路探测来寻找回源最后的一条路径，然后通过DNS的调度将所有请求调度到选定的这条路径上回源，从而加速用户访问效率。

​	由于CDN节点遍布全国，所有用户接入一个CDN节点后，可以选择一条从离用户最近的CDN节点到源站链路最好的路径让用户走。一个简单的原则就是每个CDN节点从源站上下载一个一定大小的文件，看哪个链路的总耗时最短，这个可以构成一个链路列表，然后绑定在一个DNS解析上，更新到CDN的Local DNS上。